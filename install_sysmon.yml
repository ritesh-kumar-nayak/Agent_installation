---
- name: Install Sysmon
  hosts: windows
  vars:
      path: C:\agents\sysmon
  become_method: pwsh
  tasks:
      - name: Create directory to download sysmon package
        win_file:
          path: "{{path}}"
          state: directory

      - name: Add user ownership to this directory
        win_owner:
          path: "{{path}}"
          user: ansible
          recurse: true

      - name: Download installer zip file
        ansible.windows.win_get_url:
          url: https://github.com/ritesh-kumar-nayak/agent_source_files/blob/main/Sysmon.zip
          dest: "{{path}}"

      - name: Unzip installer zip file
        community.windows.win_unzip:
          src: Sysmon.zip
          dest: "{{path}}"

      - name: Install sysmon package
        win_shell: sysmon -accepteula -i
        args:
          chdir: "{{path}}"
      
      - name: Check sysmon service installation status
        win_shell: Get-service -Name sysmon


